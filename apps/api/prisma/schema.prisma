generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company?
}

model Company {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  legalName  String
  vat        String
  iban       String
  street     String   @default("")
  city       String   @default("")
  postalCode String   @default("")
  country    String   @default("BE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  clients   Client[]
  invoices  Invoice[]
}

model Client {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name       String
  vat        String?
  email      String?
  street     String   @default("")
  city       String   @default("")
  postalCode String   @default("")
  country    String   @default("BE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  invoices   Invoice[]

  @@index([companyId, name])
}

enum InvoiceStatus {
  DRAFT
  READY
  SENT
  DELIVERED
  FAILED
}

model Invoice {
  id              String        @id @default(cuid())
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  clientId        String?
  client          Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  number          String
  issueDate       DateTime
  dueDate         DateTime
  currency        String        @default("EUR")
  totalExcl       Decimal       @db.Decimal(12, 2) @default(0)
  totalVat        Decimal       @db.Decimal(12, 2) @default(0)
  totalIncl       Decimal       @db.Decimal(12, 2) @default(0)
  status          InvoiceStatus @default(DRAFT)
  xmlPath         String?
  pdfPath         String?
  hermesMessageId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  lines InvoiceLine[]
  logs  DeliveryLog[]

  @@unique([companyId, number])
  @@index([companyId, issueDate])
}

model InvoiceLine {
  id             String  @id @default(cuid())
  invoiceId      String
  invoice        Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description    String
  quantity       Decimal @db.Decimal(10, 2) @default(1)
  unitPrice      Decimal @db.Decimal(12, 2) @default(0)
  vatRate        Decimal @db.Decimal(4, 2)  @default(0) // e.g. 0, 6, 21
  lineTotalExcl  Decimal @db.Decimal(12, 2) @default(0)
  lineVat        Decimal @db.Decimal(12, 2) @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model DeliveryLog {
  id        String   @id @default(cuid())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  timestamp DateTime @default(now())
  status    String
  message   String?
  provider  String   @default("hermes")
  createdAt DateTime @default(now())
}
